package com.recruitement.util;

import java.util.Properties;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import jakarta.mail.Authenticator;
import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.PasswordAuthentication;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeMessage;

public class EmailUtil {

    private static final Logger logger = LogManager.getLogger(EmailUtil.class);
    
    // Email configuration - Consider moving to properties file
    private static final String FROM_EMAIL = "your-email@company.com"; 
    private static final String PASSWORD = "your-app-password";  
    private static final String SMTP_HOST = "smtp.office365.com"; // or smtp.gmail.com
    private static final String SMTP_PORT = "587";
    
    /**
     * Send a plain text email
     */
    public static boolean sendEmail(String to, String subject, String body) {
        Properties props = new Properties();
        props.put("mail.smtp.auth", "true"); 
        props.put("mail.smtp.starttls.enable", "true");
        props.put("mail.smtp.host", SMTP_HOST);
        props.put("mail.smtp.port", SMTP_PORT);

        Session session = Session.getInstance(props, new Authenticator() {
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(FROM_EMAIL, PASSWORD);
            }
        });

        try {
            Message message = new MimeMessage(session);
            message.setFrom(new InternetAddress(FROM_EMAIL));
            message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(to));
            message.setSubject(subject);
            message.setText(body);

            Transport.send(message);
            logger.info("Email sent successfully to " + to);
            return true;

        } catch (MessagingException e) {
            logger.error("Failed to send email to " + to, e);
            return false;
        }
    }
    
    /**
     * Send HTML email
     */
    public static boolean sendHtmlEmail(String to, String subject, String htmlBody) {
        Properties props = new Properties();
        props.put("mail.smtp.auth", "true"); 
        props.put("mail.smtp.starttls.enable", "true");
        props.put("mail.smtp.host", SMTP_HOST);
        props.put("mail.smtp.port", SMTP_PORT);

        Session session = Session.getInstance(props, new Authenticator() {
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(FROM_EMAIL, PASSWORD);
            }
        });

        try {
            Message message = new MimeMessage(session);
            message.setFrom(new InternetAddress(FROM_EMAIL));
            message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(to));
            message.setSubject(subject);
            message.setContent(htmlBody, "text/html; charset=utf-8");

            Transport.send(message);
            logger.info("HTML email sent successfully to " + to);
            return true;

        } catch (MessagingException e) {
            logger.error("Failed to send HTML email to " + to, e);
            return false;
        }
    }
    
    /**
     * Send welcome email with credentials to new user
     */
    public static boolean sendWelcomeEmail(String to, String fullName, String username, 
                                          String password, String role) {
        String subject = "Welcome to SkillBridge - Your Account Credentials";
        
        String htmlBody = buildWelcomeEmailTemplate(fullName, username, password, role);
        
        return sendHtmlEmail(to, subject, htmlBody);
    }
    
    /**
     * Build HTML template for welcome email
     */
    private static String buildWelcomeEmailTemplate(String fullName, String username, 
                                                    String password, String role) {
        return "<!DOCTYPE html>" +
            "<html>" +
            "<head>" +
            "<style>" +
            "body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }" +
            ".container { max-width: 600px; margin: 0 auto; padding: 20px; }" +
            ".header { background-color: #2563eb; color: white; padding: 20px; text-align: center; }" +
            ".content { background-color: #f9fafb; padding: 30px; }" +
            ".credentials { background-color: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin: 20px 0; }" +
            ".credential-row { padding: 10px 0; border-bottom: 1px solid #e5e7eb; }" +
            ".credential-label { font-weight: bold; color: #6b7280; }" +
            ".credential-value { color: #1f2937; font-size: 16px; }" +
            ".button { background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin-top: 20px; }" +
            ".footer { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }" +
            ".warning { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; }" +
            "</style>" +
            "</head>" +
            "<body>" +
            "<div class='container'>" +
            "<div class='header'>" +
            "<h1>Welcome to SkillBridge</h1>" +
            "</div>" +
            "<div class='content'>" +
            "<p>Dear " + fullName + ",</p>" +
            "<p>Your account has been successfully created. Below are your login credentials:</p>" +
            "<div class='credentials'>" +
            "<div class='credential-row'>" +
            "<span class='credential-label'>Username:</span> " +
            "<span class='credential-value'>" + username + "</span>" +
            "</div>" +
            "<div class='credential-row'>" +
            "<span class='credential-label'>Password:</span> " +
            "<span class='credential-value'>" + password + "</span>" +
            "</div>" +
            "<div class='credential-row' style='border-bottom: none;'>" +
            "<span class='credential-label'>Role:</span> " +
            "<span class='credential-value'>" + role + "</span>" +
            "</div>" +
            "</div>" +
            "<div class='warning'>" +
            "<strong>⚠️ Security Notice:</strong> Please change your password after first login for security purposes." +
            "</div>" +
            "<a href='http://localhost:8080/YourApp/index.html' class='button'>Login Now</a>" +
            "<p style='margin-top: 30px;'>If you have any questions, please contact your administrator.</p>" +
            "</div>" +
            "<div class='footer'>" +
            "<p>© 2025 SkillBridge - Recruitment Management System</p>" +
            "<p>This is an automated email. Please do not reply.</p>" +
            "</div>" +
            "</div>" +
            "</body>" +
            "</html>";
    }
    
    /**
     * Send assessment assignment notification
     */
    public static boolean sendAssessmentNotification(String to, String candidateName, 
                                                     String assessmentName, String panelName) {
        String subject = "New Assessment Assigned - " + assessmentName;
        
        String htmlBody = "<!DOCTYPE html>" +
            "<html>" +
            "<body style='font-family: Arial, sans-serif;'>" +
            "<div style='max-width: 600px; margin: 0 auto; padding: 20px;'>" +
            "<h2 style='color: #2563eb;'>New Assessment Assigned</h2>" +
            "<p>Dear " + candidateName + ",</p>" +
            "<p>A new assessment has been assigned to you:</p>" +
            "<div style='background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;'>" +
            "<p><strong>Assessment:</strong> " + assessmentName + "</p>" +
            "<p><strong>Assigned by:</strong> " + panelName + "</p>" +
            "</div>" +
            "<p>Please log in to your dashboard to view and attempt the assessment.</p>" +
            "<a href='http://localhost:8080/YourApp/candidateDashboard.html' " +
            "style='background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin-top: 20px;'>" +
            "View Assessment</a>" +
            "<p style='margin-top: 30px; color: #6b7280;'>Best regards,<br>SkillBridge Team</p>" +
            "</div>" +
            "</body>" +
            "</html>";
        
        return sendHtmlEmail(to, subject, htmlBody);
    }
    
    /**
     * Send evaluation completed notification
     */
    public static boolean sendEvaluationNotification(String to, String candidateName, 
                                                     String assessmentName, int score, int totalMarks) {
        String subject = "Assessment Evaluation Completed - " + assessmentName;
        
        String htmlBody = "<!DOCTYPE html>" +
            "<html>" +
            "<body style='font-family: Arial, sans-serif;'>" +
            "<div style='max-width: 600px; margin: 0 auto; padding: 20px;'>" +
            "<h2 style='color: #10b981;'>Assessment Evaluated</h2>" +
            "<p>Dear " + candidateName + ",</p>" +
            "<p>Your assessment has been evaluated:</p>" +
            "<div style='background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;'>" +
            "<p><strong>Assessment:</strong> " + assessmentName + "</p>" +
            "<p><strong>Score:</strong> " + score + " / " + totalMarks + "</p>" +
            "</div>" +
            "<p>Log in to view your detailed results.</p>" +
            "<a href='http://localhost:8080/YourApp/candidateDashboard.html' " +
            "style='background-color: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin-top: 20px;'>" +
            "View Results</a>" +
            "<p style='margin-top: 30px; color: #6b7280;'>Best regards,<br>SkillBridge Team</p>" +
            "</div>" +
            "</body>" +
            "</html>";
        
        return sendHtmlEmail(to, subject, htmlBody);
    }
}
