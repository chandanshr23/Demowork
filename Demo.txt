<!-- Export Column Selection Modal -->
<div id="exportModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-[500px] max-h-[90vh] flex flex-col">
    <div class="flex justify-between items-center p-6 border-b">
      <h3 class="text-xl font-semibold text-gray-800">Export Options</h3>
      <button id="closeExportModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    
    <div class="p-6 overflow-y-auto flex-1">
      <!-- Export Format -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
        <select id="exportFormat" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500">
          <option value="excel">Excel (XLSX)</option>
          <option value="pdf">PDF</option>
          <option value="print">Print</option>
        </select>
      </div>
      
      <!-- Column Selection -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Columns to Export</label>
        <div class="flex items-center gap-4 mb-3">
          <button id="selectAllColumns" class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
          <button id="deselectAllColumns" class="text-sm text-gray-600 hover:text-gray-800">Deselect All</button>
        </div>
        
        <div id="columnCheckboxes" class="max-h-60 overflow-y-auto border rounded p-3 space-y-2">
          <!-- Will be dynamically populated -->
        </div>
      </div>
      
      <!-- Row Selection -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Export Rows</label>
        <div class="space-y-2">
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="radio" name="rowOption" value="all" checked class="w-4 h-4">
            <span class="text-sm">All Rows</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="radio" name="rowOption" value="current" class="w-4 h-4">
            <span class="text-sm">Current Page Only</span>
          </label>
          <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="radio" name="rowOption" value="active" class="w-4 h-4">
            <span class="text-sm">Active Users Only</span>
          </label>
        </div>
      </div>
      
      <!-- File Name -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">File Name (optional)</label>
        <input type="text" id="exportFileName" 
               class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" 
               placeholder="e.g., User_Report">
        <p class="text-xs text-gray-500 mt-1">Leave empty for default name</p>
      </div>
    </div>
    
    <div class="flex justify-end gap-2 p-6 border-t bg-gray-50">
      <button id="cancelExport" class="bg-gray-300 px-6 py-2 rounded hover:bg-gray-400">Cancel</button>
      <button id="confirmExport" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Export</button>
    </div>
  </div>
</div>


function loadUserPage(role) {
    let title = role.charAt(0) + role.slice(1).toLowerCase() + " Management";
    let tableId = role.toLowerCase() + "Table";

    let html = `
    <div class="flex justify-between mb-4">
      <h2 class="text-2xl font-bold">${title}</h2>
      <div class="flex gap-2">
        <button id="btnExportUsers" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
          <span class="material-icons text-sm">download</span> Export
        </button>
        <button id="btnAddUser" class="bg-blue-600 text-white px-4 py-2 rounded">+ Add</button>
      </div>
    </div>

    <div class="overflow-x-auto bg-white rounded shadow">
      <table id="${tableId}" class="display min-w-full">
        <thead><tr>
        <th>Status</th>
          <th>Username</th>
          <th>FullName</th>
          <th>Email</th>
          <th>Phone Number</th>
          ${role == "PANEL" ? "<th>Expertise</th>" : ""}
          ${role == "CANDIDATE" ? "<th>Panel</th>" : ""}
          <th>Actions</th>
        </tr></thead>
        <tbody id="${tableId}Body"></tbody>
      </table>
    </div>

    ${buildUserModal(role)}
    ${buildEditModal(role)}
    ${role == "CANDIDATE" ? buildAssignPanelModal() : ""}
  `;
    $("#userSection").html(html);
    loadUsers(role);
    bindUserActions(role);
}



// Store current table reference for export
let currentExportTable = null;
let currentExportRole = null;

// Export button handler
$(document).on("click", "#btnExportUsers", function() {
    let tableId = currentExportRole.toLowerCase() + "Table";
    let table = $("#" + tableId).DataTable();
    currentExportTable = table;
    
    // Get table columns
    let columns = [];
    table.columns().every(function(index) {
        let header = $(this.header()).text().trim();
        let visible = this.visible();
        
        // Exclude Actions column
        if (header !== "Actions" && visible) {
            columns.push({
                index: index,
                title: header,
                visible: visible
            });
        }
    });
    
    showExportModal(columns, table);
});

function showExportModal(columns, tableInstance) {
    $("#exportModal").removeClass("hidden");
    currentExportTable = tableInstance;
    
    // Reset to default state
    $("#exportFormat").val("excel");
    $("input[name='rowOption'][value='all']").prop("checked", true);
    $("#exportFileName").val("");
    
    // Populate column checkboxes
    let checkboxHtml = "";
    columns.forEach(col => {
        checkboxHtml += `
            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                <input type="checkbox" class="export-col-checkbox w-4 h-4" value="${col.index}" checked data-title="${col.title}">
                <span class="text-sm">${col.title}</span>
            </label>`;
    });
    $("#columnCheckboxes").html(checkboxHtml);
    
    // Select/Deselect all handlers
    $("#selectAllColumns").off("click").on("click", function() {
        $(".export-col-checkbox").prop("checked", true);
    });
    
    $("#deselectAllColumns").off("click").on("click", function() {
        $(".export-col-checkbox").prop("checked", false);
    });
    
    // Export confirmation
    $("#confirmExport").off("click").on("click", function() {
        performExport();
    });
}

function performExport() {
    let format = $("#exportFormat").val();
    let rowOption = $("input[name='rowOption']:checked").val();
    let fileName = $("#exportFileName").val().trim() || (currentExportRole + "_Report");
    
    // Get selected columns
    let selectedCols = [];
    let columnTitles = [];
    $(".export-col-checkbox:checked").each(function() {
        selectedCols.push(parseInt($(this).val()));
        columnTitles.push($(this).data("title"));
    });
    
    if (selectedCols.length === 0) {
        notyf.error("Please select at least one column");
        return;
    }
    
    // Filter rows based on selection
    let rowsToExport = getRowsToExport(rowOption);
    
    if (rowsToExport.length === 0) {
        notyf.error("No rows to export");
        return;
    }
    
    // Close modal
    $("#exportModal").addClass("hidden");
    
    // Show loading
    Swal.fire({
        title: 'Exporting...',
        html: 'Please wait while we prepare your export',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Perform export based on format
    setTimeout(() => {
        if (format === "excel") {
            exportToExcel(rowsToExport, selectedCols, columnTitles, fileName);
        } else if (format === "pdf") {
            exportToPDF(rowsToExport, selectedCols, columnTitles, fileName);
        } else if (format === "print") {
            printTable(rowsToExport, selectedCols, columnTitles);
        }
        
        Swal.close();
        notyf.success("Export completed successfully!");
    }, 500);
}

function getRowsToExport(rowOption) {
    let rows = [];
    let table = currentExportTable;
    
    if (rowOption === "all") {
        // Get all rows
        table.rows().every(function() {
            rows.push(this.data());
        });
    } else if (rowOption === "current") {
        // Get current page rows only
        table.rows({page: 'current'}).every(function() {
            rows.push(this.data());
        });
    } else if (rowOption === "active") {
        // Get only active users (status = active)
        table.rows().every(function() {
            let rowData = this.data();
            // Check if Status column contains "Active"
            if (rowData[0] && rowData[0].includes("Active")) {
                rows.push(rowData);
            }
        });
    }
    
    return rows;
}

function exportToExcel(rows, selectedCols, columnTitles, fileName) {
    // Create workbook
    let wb = XLSX.utils.book_new();
    
    // Prepare data
    let exportData = [];
    
    // Add headers
    exportData.push(columnTitles);
    
    // Add rows with selected columns only
    rows.forEach(rowData => {
        let row = [];
        selectedCols.forEach(colIndex => {
            let cellData = rowData[colIndex] || "";
            // Clean HTML tags
            cellData = $("<div>").html(cellData).text().trim();
            row.push(cellData);
        });
        exportData.push(row);
    });
    
    // Create worksheet
    let ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // Set column widths
    let colWidths = columnTitles.map(() => ({wch: 20}));
    ws['!cols'] = colWidths;
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, "Users");
    
    // Save file
    XLSX.writeFile(wb, fileName + ".xlsx");
}

function exportToPDF(rows, selectedCols, columnTitles, fileName) {
    // Create printable HTML
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${fileName}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { color: #333; text-align: center; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #4a5568; color: white; padding: 10px; text-align: left; border: 1px solid #ddd; }
                td { padding: 8px; border: 1px solid #ddd; }
                tr:nth-child(even) { background-color: #f9fafb; }
                .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
            </style>
        </head>
        <body>
            <h1>${currentExportRole} Report</h1>
            <p style="text-align: center; color: #666;">Generated on ${new Date().toLocaleString()}</p>
            <table>
                <thead>
                    <tr>
                        ${columnTitles.map(title => `<th>${title}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(rowData => {
                        let rowHtml = '<tr>';
                        selectedCols.forEach(colIndex => {
                            let cellData = rowData[colIndex] || "";
                            cellData = $("<div>").html(cellData).text().trim();
                            rowHtml += `<td>${cellData}</td>`;
                        });
                        rowHtml += '</tr>';
                        return rowHtml;
                    }).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>Â© 2025 SkillBridge - Recruitment Management System</p>
            </div>
        </body>
        </html>
    `;
    
    // Open print window
    let printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    
    // Wait for content to load then trigger print
    printWindow.onload = function() {
        printWindow.print();
        // Close window after printing (optional)
        setTimeout(() => {
            printWindow.close();
        }, 100);
    };
}

function printTable(rows, selectedCols, columnTitles) {
    // Same as PDF but directly print
    exportToPDF(rows, selectedCols, columnTitles, currentExportRole + "_Report");
}

// Close export modal
$("#closeExportModal, #cancelExport").click(function() {
    $("#exportModal").addClass("hidden");
});



function loadUsers(role) {
    currentExportRole = role; // Store current role for export
    let tableId = role.toLowerCase() + "Table";

    if ($.fn.DataTable.isDataTable("#" + tableId)) {
        $("#" + tableId).DataTable().destroy();
        $("#" + tableId + "Body").empty(); 
    }

    ajaxGet("getAllUsersByRole", {
        role: role
    }, function(res) {
        if (res.status == "success" && res.users && res.users.length > 0) {
            res.users.sort((a,b)=>{
                let statusA=a.status?1:0;
                let statusB=b.status?1:0;
                return statusB-statusA;
            });
            
            let rows = "";
            res.users.forEach((u) => {
                rows += buildTableRow(u, role);
            });
            $("#" + tableId + "Body").html(rows);

            // Initialize DataTable without default export buttons
            $("#" + tableId).DataTable({
                paging: true,
                searching: true,
                info: true,
                responsive: true,
                ordering: false,
                autoWidth: false,
                columnDefs: [{
                    targets: -1, 
                    orderable: false,
                    className: 'text-center'
                }],
                destroy: true
            });
        } else {
            let colCount = role == "PANEL" ? 7 : role == "CANDIDATE" ? 7 : 6;
            $("#" + tableId + "Body").html(
                `<tr><td colspan="${colCount}" class="text-center">No users found</td></tr>`
            );
        }
    });
}



<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
