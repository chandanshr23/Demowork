<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Recruitment Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind CSS -->
    <link href="./Plugins/tailwind.min.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="./Plugins/jquery-3.6.0.min.js"></script>
    <!-- Apex Charts -->
    <script src="./Plugins/apexcharts.js"></script>
    <!-- Datatables -->
    <link rel="stylesheet" href="./Plugins/jquery.dataTables.min.css" />
    <script src="./Plugins/jquery.dataTables.min.js"></script>
    <!-- Material Icons -->
    <link href="./Plugins/icon.css" rel="stylesheet" />
    <!-- Sweet Alerts -->
    <script src="./Plugins/sweetalert2@11.js"></script>
    <script src="./Plugins/sweetalert2.all.min.js"></script>
    <!-- Notyf -->
    <link rel="stylesheet" href="./Plugins/notyf.min.css" />
    <script src="./Plugins/notyf.min.js"></script>
    <!-- Datatable buttons -->
    <link rel="stylesheet" href="./Plugins/buttons.dataTables.min.css" />
    <script src="./Plugins/dataTables.buttons.min.js"></script>
    <!-- Export Pdf, Html, Print -->
    <script src="./Plugins/jszip.min.js"></script>
    <script src="./Plugins/pdfmake.min.js"></script>
    <script src="./Plugins/vfs_fonts.js"></script>
    <script src="./Plugins/buttons.html5.min.js"></script>
    <script src="./Plugins/buttons.print.min.js"></script>
    
    <style>
      .dt-button {
      background-color: #2563eb !important;
      color: white !important;
      border-radius: 0.375rem;
      padding: 6px 12px;
      border: none;
      font-size: 14px;
      }
      .dt-button:hover {
      background-color: #1e40af !important;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-black shadow-md fixed top-0 left-0 w-full z-50">
      <div class="container mx-auto flex justify-between items-center px-6 py-3">
        <div class="flex items-center space-x-2">
          <span class="material-icons text-white text-3xl">group_work</span>
          <h1 class="text-2xl font-bold text-white tracking-tight">SkillBridge</h1>
        </div>
        <!-- Navigation -->
        <nav class="flex items-center space-x-6 text-white font-medium">
          <button id="navDashboard" class="flex items-center gap-1 hover:text-blue-400 transition">
          <span class="material-icons text-white">dashboard</span> Dashboard
          </button>
          <button id="navAdmins" class="flex items-center gap-1 hover:text-blue-400 transition">
          <span class="material-icons text-white">supervisor_account</span> Admins
          </button>
          <button id="navPanels" class="flex items-center gap-1 hover:text-blue-400 transition">
          <span class="material-icons text-white">groups</span> Panels
          </button>
          <button id="navCandidates" class="flex items-center gap-1 hover:text-blue-400 transition">
          <span class="material-icons text-white">person</span> Candidates
          </button>
        </nav>
        
        <!-- Logout -->
        <div class="flex items-center space-x-3">
          <span class="material-icons text-white text-2xl">person</span>
          <span id="userFullName" class="text-white font-medium"></span>
          <button id="logoutBtn" class="flex items-center gap-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
          <span class="material-icons">logout</span> Logout
          </button>
        </div>
      </div>
    </header>
    <!-- Main -->
    <main class="flex-1 container mx-auto px-6 py-24 space-y-8">
      <!-- Dashboard-->
      <section id="dashboardSection">
        <!-- Cards -->
        <div class="grid grid-cols-1 my-10 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div id="cardCandidatesBox"
            class="bg-white shadow rounded-lg p-5 text-center cursor-pointer hover:shadow-lg transition">
            <span class="material-icons text-blue-600 text-4xl mb-2">people</span>
            <p class="text-gray-500">Candidates</p>
            <p id="cardCandidates" class="text-3xl font-bold text-blue-700">0</p>
          </div>
          <div id="cardPanelsBox"
            class="bg-white shadow rounded-lg p-5 text-center cursor-pointer hover:shadow-lg transition">
            <span class="material-icons text-green-600 text-4xl mb-2">person_outline</span>
            <p class="text-gray-500">Panels</p>
            <p id="cardPanels" class="text-3xl font-bold text-green-700">0</p>
          </div>
          <div class="bg-white shadow rounded-lg p-5 text-center">
            <span class="material-icons text-purple-600 text-4xl mb-2">assignment</span>
            <p class="text-gray-500">Tests</p>
            <p id="cardTests" class="text-3xl font-bold text-purple-700">0</p>
          </div>
          <div class="bg-white shadow rounded-lg p-5 text-center">
            <span class="material-icons text-orange-600 text-4xl mb-2">check_circle</span>
            <p class="text-gray-500">Completed</p>
            <p id="cardCompleted" class="text-3xl font-bold text-orange-700">0</p>
          </div>
        </div>
        <!-- Charts adn Graphs-->
        <div class="grid my-10 grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-1">
              <span class="material-icons text-blue-600">bar_chart</span> Test Completion Status
            </h3>
            <div id="completionChart"></div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-1">
              <span class="material-icons text-green-600">show_chart</span> Average Time per Test (mins)
            </h3>
            <div id="avgTimeChart"></div>
          </div>
        </div>
        <!-- Recent Submissions-->
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold flex items-center gap-1">
              <span class="material-icons text-blue-600">leaderboard</span>Recent Submissions
            </h3>
          </div>
          <div class="overflow-x-auto">
            <table id="leaderboardTable" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-600">Candidate</th>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-600">Test</th>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-600">Status</th>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-600">Score</th>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-600">Time (mins)</th>
                </tr>
              </thead>
              <tbody id="recentBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </section>
      <section id="userSection" class="hidden">
       <div class="flex items-center space-x-3 cursor-pointer" id="openProfile"></div>
     </section>
    </main>
    <!-- Assign Panel -->
    <div id="assignPanelModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-96 max-h-[80vh] flex flex-col p-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">Assign Panel</h3>
        <input type="hidden" id="assignCandidateId" />
        <label class="block text-sm mb-2 font-medium text-gray-600">Select Panel Member</label>
        <div class="flex-1 overflow-y-auto mb-4">
          <select id="assignPanelSelect" class="w-full border rounded p-2" size="8">
            <option>Loading...</option>
          </select>
        </div>
        <div class="flex justify-end gap-2 border-t pt-4">
          <button id="assignCancel" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
          <button id="assignSave" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
        </div>
      </div>
    </div>
    <!-- Edit User -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-96 p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Edit User</h3>
        <form id="editUserForm" class="space-y-3">
          <input type="hidden" id="editUserId" />
          <div>
            <label class="block text-sm text-gray-600 mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" id="editFullName" class="w-full border rounded p-2" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Email <span class="text-red-500">*</span></label>
            <input type="email" id="editEmail" class="w-full border rounded p-2" required readonly/>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Phone</label>
            <input type="tel" id="editPhone" class="w-full border rounded p-2" pattern="[0-9]{10}" />
          </div>
          <div id="editExpertiseBlock" class="hidden">
            <label class="block text-sm text-gray-600 mb-1">Expertise</label>
            <input type="text" id="editExpertise" class="w-full border rounded p-2"placeholder="E.g., Java, Spring Boot" />
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="editStatus" class="mr-2" />
            <label for="editStatus" class="text-sm text-gray-700">Active</label>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" id="cancelEditModal" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Profile Slide Panel -->
<div id="profilePanel" class="hidden fixed inset-0 bg-black/50 z-50">
  <div class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300" id="profileSlide">
    <div class="p-6 border-b flex justify-between items-center">
      <h2 class="text-xl font-bold">My Profile</h2>
      <button id="closeProfile" class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    
    <div class="p-6 space-y-6 overflow-y-auto h-[calc(100%-80px)]">
      <!-- Profile Info -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Username</label>
          <input type="text" id="profileUsername" class="w-full border rounded p-2 bg-gray-100" readonly>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Email</label>
          <input type="email" id="profileEmail" class="w-full border rounded p-2 bg-gray-100" readonly>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Full Name</label>
          <input type="text" id="profileFullName" class="w-full border rounded p-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Phone</label>
          <input type="tel" id="profilePhone" class="w-full border rounded p-2">
        </div>
        <div id="profileExpertiseBlock" class="hidden">
          <label class="block text-sm text-gray-600 mb-1">Expertise</label>
          <input type="text" id="profileExpertise" class="w-full border rounded p-2">
        </div>
        <button id="saveProfile" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Save Changes</button>
      </div>

      <!-- Change Password Section -->
      <div class="border-t pt-6 space-y-4">
        <h3 class="font-semibold text-gray-800">Change Password</h3>
        <div>
          <input type="password" id="currentPassword" placeholder="Current Password" class="w-full border rounded p-2">
        </div>
        <div>
          <input type="password" id="newPassword" placeholder="New Password (min 8 chars)" class="w-full border rounded p-2">
        </div>
        <div>
          <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="w-full border rounded p-2">
        </div>
        <button id="changePassword" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Change Password</button>
      </div>
    </div>
  </div>
</div>
    <!-- Footer -->
    <footer class="bg-white text-center py-4 shadow-inner text-gray-500"> © 2025 RecruitmentPro - All rights reserved.</footer>
    <script src="utils.js"></script>
    <script src="adminDashboard.js"></script>
  </body>
</html>
function showConfirm(title, text, icon = "question", confirmText = "Yes") {
    return Swal.fire({
        title,
        text,
        icon,
        showCancelButton: true,
        confirmButtonColor: "#2563eb",
        cancelButtonColor: "#6b7280",
        confirmButtonText: confirmText,
    });
}

let currentUserInfo = {
    userId: null,
    role: null
};

$(document).on("click", "#cardCandidatesBox", function() {
    $("#navCandidates").trigger("click");
});

$(document).on("click", "#cardPanelsBox", function() {
    $("#navPanels").trigger("click");
});

$(document).ready(function() {
    getUserDetails();

    $("#navDashboard").click(() => {
        $("#dashboardSection").show();
        $("#userSection").hide();
        loadDashboard();
    });

    $("#navAdmins").click(() => showUserSection("ADMIN"));
    $("#navPanels").click(() => showUserSection("PANEL"));
    $("#navCandidates").click(() => showUserSection("CANDIDATE"));
    $("#logoutBtn").click(() => logoutUser());

    $("#dashboardSection").show();
    $("#userSection").hide();
    loadDashboard();
});


function showUserSection(role) {
    $("#dashboardSection").hide();
    $("#userSection").show();
    $("#userSection").html(
        `<div class='text-center text-gray-500 py-10'>Loading ${role} data...</div>`
    );
    loadUserPage(role);
}

let completionChart = null;
let avgTimeChart = null;

//Admin Dashboard Charts
function loadDashboard() {
    ajaxGet(
        "adminDashboardData", {},
        function(res) {
            try {
                let cards = res && res.cards ? res.cards : {};
                $("#cardCandidates").text(cards.candidates ?? "--");
                $("#cardPanels").text(cards.panels ?? "--");
                $("#cardTests").text(cards.tests ?? "--");
                $("#cardCompleted").text(cards.completed ?? "--");

                if (completionChart) {
                    completionChart.destroy();
                    completionChart = null;
                }
                if (avgTimeChart) {
                    avgTimeChart.destroy();
                    avgTimeChart = null;
                }

                $("#completionChart").empty();
                $("#avgTimeChart").empty();

                let completionLabels = [
                    "Java Test",
                    "Python Test",
                    "ReactJS Test",
                    "SQL Test",
                    "DevOps Test",
                ];
                let completionValues = [85, 92, 78, 88, 95];

                if (
                    res.completion &&
                    Array.isArray(res.completion.labels) &&
                    res.completion.labels.length > 0
                ) {
                    completionLabels = res.completion.labels;
                    completionValues = res.completion.values || [];
                }

                var completionOptions = {
                    series: [{
                        name: "Completion %",
                        data: completionValues,
                    }, ],
                    chart: {
                        type: "bar",
                        height: 300,
                        toolbar: {
                            show: true,
                            tools: {
                                download: true,
                                zoom: false,
                                zoomin: false,
                                zoomout: false,
                                pan: false,
                                reset: false,
                            },
                        },
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 4,
                            dataLabels: {
                                position: "top",
                            },
                        },
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function(val) {
                            return val + "%";
                        },
                        offsetY: -20,
                        style: {
                            fontSize: "12px",
                            colors: ["#304758"],
                        },
                    },
                    xaxis: {
                        categories: completionLabels,
                        position: "bottom",
                        labels: {
                            rotate: -45,
                            rotateAlways: true,
                        },
                    },
                    yaxis: {
                        min: 0,
                        max: 100,
                        labels: {
                            formatter: function(val) {
                                return val + "%";
                            },
                        },
                    },
                    colors: ["#3b82f6"],
                    title: {
                        text: "Test Completion Percentage",
                        align: "center",
                        style: {
                            fontSize: "14px",
                            fontWeight: "bold",
                        },
                    },
                };

                completionChart = new ApexCharts(
                    document.querySelector("#completionChart"),
                    completionOptions
                );
                completionChart.render();

                let avgTimeLabels = [
                    "Java Test",
                    "Python Test",
                    "ReactJS Test",
                    "SQL Test",
                    "DevOps Test",
                ];
                let avgTimeValues = [45, 38, 52, 41, 35];

                if (
                    res.avgTime &&
                    Array.isArray(res.avgTime.labels) &&
                    res.avgTime.labels.length > 0
                ) {
                    avgTimeLabels = res.avgTime.labels;
                    avgTimeValues = res.avgTime.values || [];
                }

                var avgTimeOptions = {
                    series: [{
                        name: "Average Time (mins)",
                        data: avgTimeValues,
                    }, ],
                    chart: {
                        type: "line",
                        height: 300,
                        toolbar: {
                            show: true,
                            tools: {
                                download: true,
                                zoom: false,
                                zoomin: false,
                                zoomout: false,
                                pan: false,
                                reset: false,
                            },
                        },
                    },
                    stroke: {
                        curve: "smooth",
                        width: 3,
                    },
                    markers: {
                        size: 5,
                        hover: {
                            size: 7,
                        },
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function(val) {
                            return val + " min";
                        },
                        style: {
                            fontSize: "11px",
                        },
                    },
                    xaxis: {
                        categories: avgTimeLabels,
                        labels: {
                            rotate: -45,
                            rotateAlways: true,
                        },
                    },
                    yaxis: {
                        min: 0,
                        labels: {
                            formatter: function(val) {
                                return val + " min";
                            },
                        },
                    },
                    colors: ["#10b981"],
                    title: {
                        text: "Average Completion Time",
                        align: "center",
                        style: {
                            fontSize: "14px",
                            fontWeight: "bold",
                        },
                    },
                    grid: {
                        borderColor: "#e7e7e7",
                        row: {
                            colors: ["#f3f3f3", "transparent"],
                            opacity: 0.5,
                        },
                    },
                };

                avgTimeChart = new ApexCharts(
                    document.querySelector("#avgTimeChart"),
                    avgTimeOptions
                );
                avgTimeChart.render();

                let recent = Array.isArray(res.recent) ? res.recent : [];
                let rows = recent
                    .map(
                        (r) => `
        <tr>
          <td class="px-3 py-2">${r.candidate ?? "-"}</td>
          <td class="px-3 py-2">${r.test ?? "-"}</td>
          <td class="px-3 py-2">${r.status ?? "-"}</td>
          <td class="px-3 py-2">${r.score ?? "-"}</td>
          <td class="px-3 py-2">${r.timeTaken ?? "-"}</td>
        </tr>
      `
                    )
                    .join("");
                $("#recentBody").html(
                    rows ||
                    `<tr><td colspan="5" class="text-center text-gray-500">No recent submissions</td></tr>`
                );

                $("#leaderboardTable").DataTable({
                    destroy: true,
                    dom: "Bfrtip",
                    buttons: [{
                            extend: "excelHtml5",
                            title: "Leaderboard_Report",
                            className: "bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700",
                            exportOptions: {
                                columns: ":visible"
                            },
                        },
                        {
                            extend: "pdfHtml5",
                            title: "Leaderboard_Report",
                            className: "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700",
                            orientation: "landscape",
                            pageSize: "A4",
                            exportOptions: {
                                columns: ":visible"
                            },
                        },
                        {
                            extend: "print",
                            title: "Leaderboard Report",
                            className: "bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700",
                        },
                    ],
                    paging: true,
                    searching: true,
                    info: true,
                    responsive: true,
                });
            } catch (e) {
                console.error("Error processing dashboard response:", e);
                notyf.error("Error loading dashboard");
            }
        },
        function() {
            notyf.error("Unable to fetch dashboard data");
            $("#cardCandidates,#cardPanels,#cardTests,#cardCompleted").text("--");
            $("#recentBody").html(
                `<tr><td colspan="5" class="text-center text-gray-500">Unable to load data</td></tr>`
            );
        }
    );
}

function loadUserPage(role) {
    let title = role.charAt(0) + role.slice(1).toLowerCase() + " Management";
    let tableId = role.toLowerCase() + "Table";

    let html = `
    <div class="flex justify-between mb-4">
      <h2 class="text-2xl font-bold">${title}</h2>
      <button id="btnAddUser" class="bg-blue-600 text-white px-4 py-2 rounded">+ Add</button>
    </div>

    <div class="overflow-x-auto bg-white rounded shadow">
      <table id="${tableId}" class="display min-w-full">
        <thead><tr>
          <th>Username</th>
          <th>FullName</th>
          <th>Email</th>
          <th>Phone Number</th>
          ${role == "PANEL" ? "<th>Expertise</th>" : ""}
          ${role == "CANDIDATE" ? "<th>Panel</th>" : ""}
          <th>Actions</th>
        </tr></thead>
        <tbody id="${tableId}Body"></tbody>
      </table>
    </div>

    ${buildUserModal(role)}
    ${buildEditModal(role)}
    ${role == "CANDIDATE" ? buildAssignPanelModal() : ""}
  `;
    $("#userSection").html(html);
    loadUsers(role);
    bindUserActions(role);
}
$(document).ready(function() {
  $("#openProfile").click(() => openProfilePanel());
  $("#closeProfile").click(() => closeProfilePanel());
  
  $("#saveProfile").click(function() {
    let data = {
      user_id: sessionStorage.getItem("user_id"),
      full_name: $("#profileFullName").val(),
      phone_no: $("#profilePhone").val(),
      expertise: $("#profileExpertise").val() || ""
    };
    
    ajaxPost("updateUser", data, function(res) {
      if (res.status == "success") {
        notyf.success("Profile updated");
        closeProfilePanel();
        getUserDetails();
      } else {
        notyf.error(res.message);
      }
    });
  });
  
  $("#changePassword").click(function() {
    let current = $("#currentPassword").val();
    let newPass = $("#newPassword").val();
    let confirm = $("#confirmPassword").val();
    
    if (!current || !newPass || !confirm) {
      notyf.error("Fill all password fields");
      return;
    }
    
    if (newPass.length < 8) {
      notyf.error("Password must be 8+ characters");
      return;
    }
    
    if (newPass !== confirm) {
      notyf.error("Passwords don't match");
      return;
    }
    
    ajaxPost("changePassword", {
      current_password: current,
      new_password: newPass
    }, function(res) {
      if (res.status == "success") {
        notyf.success("Password changed");
        $("#currentPassword, #newPassword, #confirmPassword").val("");
      } else {
        notyf.error(res.message);
      }
    });
  });
});

function buildUserModal(role) {
    return `
    <div id="userModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white w-96 p-6 rounded shadow-lg max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-3">Add User</h3>
        <form id="userForm" class="space-y-3">
        <div>
          <input type="text" id="username" placeholder="Username" class="w-full border rounded p-2" required>
          <p id="username_error" class="text-red-500 text-xs mt-1"></p>
        </div>
        <div>
          <input type="text" id="fullName" placeholder="FullName" class="w-full border rounded p-2" required>
          <p id="fullName_error" class="text-red-500 text-xs mt-1"></p>
        </div>
        <div>
          <input type="email" id="email" placeholder="Email" class="w-full border rounded p-2" required>
          <p id="email_error" class="text-red-500 text-xs mt-1"></p>
        </div>
        <div>
           <input type="password" id="password" placeholder="Password" class="w-full border rounded p-2" required>
          <p id="password_error" class="text-red-500 text-xs mt-1"></p>
        </div>
        <div>
          <input type="tel" id="phone" placeholder="Phone Number" class="w-full border rounded p-2" required>
          <p id="phone_error" class="text-red-500 text-xs mt-1"></p>
        </div>
        ${
          role == "PANEL"
            ? `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Select Expertise (multiple)</label>
            <select id="expertise" multiple class="w-full border rounded p-2 h-28 focus:ring-2 focus:ring-blue-500">
              <option value="Java">Java</option>
              <option value="Python">Python</option>
              <option value="C++">C++</option>
              <option value="ReactJS">ReactJS</option>
              <option value="Spring Boot">Spring Boot</option>
              <option value="Database (SQL)">Database (SQL)</option>
              <option value="DevOps">DevOps</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Hold Ctrl to select multiple</p>
          </div>
          `
            : ""
        }
          <div class="flex justify-end gap-2">
            <button type="button" id="cancelModal" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
  `;
}

function buildEditModal(role) {
    return `
    <div id="editUserModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white w-96 p-6 rounded shadow-lg max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-3">Edit User</h3>
        <form id="editUserForm" class="space-y-3">
          <input type="hidden" id="editUserId">
          <div>
            <input type="text" id="editFullName" placeholder="Full Name" class="w-full border rounded p-2" required>
            <p id="editFullName_error" class="text-red-500 text-xs mt-1"></p>
          </div>
          <div>
            <input type="email" id="editEmail" placeholder="Email" class="w-full border rounded p-2" required>
            <p id="editEmail_error" class="text-red-500 text-xs mt-1"></p>
          </div>
          <div>
            <input type="tel" id="editPhone" placeholder="Phone Number" class="w-full border rounded p-2" required>
            <p id="editPhone_error" class="text-red-500 text-xs mt-1"></p>
          </div>
          <div id="editExpertiseBlock" style="display: ${
            role == "PANEL" ? "block" : "none"
          };">
            <label class="block text-sm font-medium text-gray-700 mb-1">Select Expertise (multiple)</label>
            <select id="editExpertise" multiple class="w-full border rounded p-2 h-28 focus:ring-2 focus:ring-blue-500">
              <option value="Java">Java</option>
              <option value="Python">Python</option>
              <option value="C++">C++</option>
              <option value="ReactJS">ReactJS</option>
              <option value="Spring Boot">Spring Boot</option>
              <option value="Database (SQL)">Database (SQL)</option>
              <option value="DevOps">DevOps</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Hold Ctrl to select multiple</p>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="cancelEditModal" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Update</button>
          </div>
        </form>
      </div>
    </div>
  `;
}

function buildAssignPanelModal() {
    return `
    <div id="assignPanelModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white w-96 p-6 rounded shadow-lg">
        <h3 class="text-lg font-semibold mb-3">Assign Panel</h3>
        <input type="hidden" id="assignCandidateId">
        <select id="assignPanelSelect" class="w-full border rounded p-2 mb-4">
          <option>Loading...</option>
        </select>
        <div class="flex justify-end gap-2">
          <button type="button" id="assignCancel" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
          <button type="button" id="assignSave" class="bg-blue-600 text-white px-4 py-2 rounded">Assign</button>
        </div>
      </div>
    </div>
  `;
}

function loadUsers(role) {
    let tableId = role.toLowerCase() + "Table";

    if ($.fn.DataTable.isDataTable("#" + tableId)) {
        $("#" + tableId).DataTable().destroy();
        $("#" + tableId + "Body").empty(); 
    }

    ajaxGet("getAllUsersByRole", {
        role: role
    }, function(res) {
        if (res.status == "success" && res.users && res.users.length > 0) {
            let rows = "";
            res.users.forEach((u) => {
                rows += buildTableRow(u, role);
            });
            $("#" + tableId + "Body").html(rows);

            // initialize DataTable 
            $("#" + tableId).DataTable({
                paging: true,
                searching: true,
                info: true,
                responsive: true,
                ordering: true,
                autoWidth: false, 
                columnDefs: [{
                    targets: -1, 
                    orderable: false,
                    className: 'text-center'
                }],
                dom: "Bfrtip",
                destroy: true,
                buttons: [{
                        extend: "pdfHtml5",
                        title: role + "_Users_Report",
                        className: "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700",
                        orientation: "landscape",
                        pageSize: "A4",
                        exportOptions: {
                            columns: ":visible"
                        },
                    },
                    {
                        extend: "print",
                        title: role + " Users Report",
                        className: "bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700",
                    },
                ],
            });
        } else {
            let colCount = role == "PANEL" ? 6 : role == "CANDIDATE" ? 6 : 5;
            $("#" + tableId + "Body").html(
                `<tr><td colspan="${colCount}" class="text-center">No users found</td></tr>`
            );
        }
    });
}

function buildTableRow(user, role) {
    let isOwnAccount = String(currentUserInfo.userId) === String(user.user_id);
    let isInactive = user.status === false || user.status === 0;

    let disabledClass = isInactive ? "opacity-50 cursor-not-allowed" : "";
    let disabledAttr = isInactive ? "disabled" : "";

    let html = "<tr>";
    html += "<td>" + (user.username || "-") + "</td>";
    html += "<td>" + (user.full_name || "-") + "</td>";
    html += "<td>" + (user.email || "-") + "</td>";
    html += "<td>" + (user.phone_no || "-") + "</td>";

    if (role == "PANEL") {
        html += "<td>" + (user.expertise || "-") + "</td>";
    }

    if (role == "CANDIDATE") {
        html += "<td>" + (user.panel_name || "Not Assigned") + "</td>";
    }

    html += `<td class="whitespace-nowrap">
    <div class="inline-flex items-center gap-1">`;

    if (role == "CANDIDATE") {
        html += `<button class="assignPanel bg-indigo-600 text-white px-2 py-1 rounded text-xs ${disabledClass}" data-id="${user.user_id}" ${disabledAttr}>Assign Panel</button>`;
    }

    html += `<button class="editUser bg-yellow-500 text-white px-2 py-1 rounded text-xs ${disabledClass}" data-id="${user.user_id}" ${disabledAttr}>Edit</button>`;

    if (!isOwnAccount) {
        html += `<button class="deleteUser bg-red-600 text-white px-2 py-1 rounded text-xs ${disabledClass}" data-id="${user.user_id}" ${disabledAttr}>Delete</button>`;
    } else {
        html += `<span class="text-gray-400 text-xs italic ml-1">Your Account</span>`;
    }

    if (isInactive) {
        html += `<button class="restoreUser bg-green-600 text-white px-2 py-1 rounded text-xs" data-id="${user.user_id}">Restore</button>`;
        html += `<span class="text-red-500 text-xs font-bold ml-1">INACTIVE</span>`;
    }

    html += `</div></td></tr>`;
    return html;
}

function bindUserActions(role) {
    // Unbind previous events
    $("#btnAddUser").off("click");
    $("#cancelModal").off("click");
    $("#username").off("input");
    $("#email").off("input");
    $("#userForm").off("input");
    $("#userForm").off("submit");
    $(document).off("click", "#cancelEditModal");
    $(document).off("click", ".assignPanel");
    $(document).off("click", ".editUser");
    $(document).off("click", ".deleteUser");
    $("#assignCancel").off("click");
    $("#assignSave").off("click");
    $("#editUserForm").off("submit");
    $("#editFullName").off("input");
    $("#editEmail").off("input");
    $("#editPhone").off("input");

    //Add user Modal
    $("#btnAddUser").click(() => {
        $("#userForm")[0].reset();
        $(".border-red-500").removeClass("border-red-500");
        $("[id$='_error']").text("");
        toggleModal("userModal", true);
    });

    $("#cancelModal").click(() => toggleModal("userModal", false));

    // validation for username
    let usernameCheckTimer = null;
    $("#username").on("input", function() {
        clearTimeout(usernameCheckTimer);
        let username = $(this).val().trim();

        if (username.length == 0) {
            clearError("username");
            return;
        }

        if (username.length < 8) {
            showError("username", "Username must be at least 8 characters");
            return;
        }

        usernameCheckTimer = setTimeout(() => {
            ajaxGet("checkUsername", {
                username: username
            }, function(res) {
                if (res.status == "error" && res.message.includes("taken")) {
                    showError("username", "Username already taken");
                } else if (res.status == "success") {
                    clearError("username");
                    $("#username_error").html(
                        "<span class='text-green-600 text-xs'>✓ Available</span>"
                    );
                } else {
                    showError("username", "Error checking availability");
                }
            });
        }, 400);
    });

    //  validation for email
    let emailCheckTimer = null;
    $("#email").on("input", function() {
        clearTimeout(emailCheckTimer);
        let email = $(this).val().trim();

        if (!email.length) {
            clearError("email");
            return;
        }

        emailCheckTimer = setTimeout(() => {
            ajaxGet("checkUsername", {
                email: email
            }, function(res) {
                if (res.status == "exists") {
                    showError("email", "Email is already registered");
                } else if (res.status == "success") {
                    clearError("email");
                    $("#email_error").html(
                        "<span class='text-green-600 text-xs'>✓ Valid email</span>"
                    );
                } else {
                    showError("email", "Error checking availability");
                }
            });
        }, 400);
    });

    // validation for other fields
    $("#userForm").on("input", "input", function() {
        let id = $(this).attr("id");
        if (id !== "username" && id !== "email") {
            validateField(id);
        }
    });

    function validateField(id) {
        let value = $("#" + id).val().trim();
        switch (id) {
            case "fullName":
                return value.length < 3 ?
                    showError(id, "Full name must be at least 3 characters") :
                    clearError(id);
            case "password":
                return value.length < 8 ?
                    showError(id, "Password must be at least 8 characters") :
                    clearError(id);
            case "phone":
                return !isValidPhone(value) ?
                    showError(id, "Enter valid 10-digit number") :
                    clearError(id);
        }
    }

    // Submit Add User Form
    $("#userForm").submit(function(e) {
        e.preventDefault();

        let isValid = true;
        ["username", "fullName", "email", "password", "phone"].forEach((id) => {
            validateField(id);
            let errorText = $("#" + id + "_error").text();
            if (
                errorText !== "" &&
                !errorText.includes("Available") &&
                !errorText.includes("Valid")
            ) {
                isValid = false;
            }
        });

        if ($("#username_error").text().includes("taken")) {
            notyf.error("Username already taken, please choose a unique one");
            return;
        }

        if ($("#email_error").text().includes("registered")) {
            notyf.error("Please try with valid email");
            return;
        }

        if (!isValid) {
            notyf.error("Please correct highlighted errors");
            return;
        }

        let expertise = $("#expertise").val();
        ajaxPost(
            "addUser", {
                role,
                full_name: $("#fullName").val(),
                username: $("#username").val(),
                email: $("#email").val(),
                password: $("#password").val(),
                phone: $("#phone").val(),
                expertise: (expertise || []).join(","),
            },
            function(res) {
                if (res.status == "success") {
                    notyf.success(res.message || "User added successfully");
                    toggleModal("userModal", false);
                    $("#userForm")[0].reset();
                    loadUsers(role);
                } else {
                    notyf.error(res.message || "Failed to add user");
                }
            }
        );
    });

    // Assign Panel
    $(document).on("click", ".assignPanel", function() {
        let candidateId = $(this).data("id");
        $("#assignCandidateId").val(candidateId);
        $("#assignPanelSelect").html("<option>Loading...</option>");
        toggleModal("assignPanelModal", true);

        ajaxGet("getAllUsersByRole", {
            role: "PANEL"
        }, function(res) {
            if (res.status == "success" && Array.isArray(res.users)) {
                let options = res.users
                    .map(
                        (u) =>
                        `<option value="${u.user_id}">${u.full_name} (${u.expertise || "-"})</option>`
                    )
                    .join("");
                $("#assignPanelSelect").html(options);
            } else {
                $("#assignPanelSelect").html(
                    "<option disabled>No panels available</option>"
                );
            }
        });
    });

    $("#assignCancel").click(() => toggleModal("assignPanelModal", false));

    $("#assignSave").click(() => {
        let candidateId = $("#assignCandidateId").val();
        let panelId = $("#assignPanelSelect").val();

        if (panelId == null) {
            notyf.error("Please select a panel member!");
            return;
        }

        ajaxPost("assignPanel", {
            candidateId,
            panelId
        }, function(res) {
            if (res.status == "success") {
                notyf.success(res.message);
                toggleModal("assignPanelModal", false);
                loadUsers("CANDIDATE");
            } else {
                notyf.error(res.message);
            }
        });
    });

    // Edit User
    let originalUserData = {};

    $(document).on("click", ".editUser", function() {
        let userId = $(this).data("id");

        ajaxGet("getUserById", {
            user_id: userId
        }, function(res) {
            if (res.status == "success" && res.user) {
                let user = res.user;

                originalUserData = {
                    full_name: user.full_name,
                    email: user.email,
                    phone_no: user.phone_no,
                    expertise: user.expertise || ""
                };

                $("#editUserId").val(user.user_id);
                $("#editFullName").val(user.full_name);
                $("#editEmail").val(user.email);
                $("#editPhone").val(user.phone_no);

                if (user.role == "PANEL") {
                    $("#editExpertiseBlock").show();
                    let expertiseArr = user.expertise ? user.expertise.split(",") : [];
                    $("#editExpertise").val(expertiseArr);
                } else {
                    $("#editExpertiseBlock").hide();
                }

                $(".border-red-500").removeClass("border-red-500");
                $("[id^='edit'][id$='_error']").text("");

                toggleModal("editUserModal", true);
            } else {
                notyf.error("Unable to fetch user details");
            }
        });
    });

    //  validation for edit form
    function validateEditField(id) {
        let value = $("#" + id).val().trim();

        switch (id) {
            case "editFullName":
                if (value.length < 3) {
                    showError(id, "Full name must be at least 3 characters");
                    return false;
                } else {
                    clearError(id);
                    return true;
                }
            case "editPhone":
                if (!isValidPhone(value)) {
                    showError(id, "Enter valid 10-digit number");
                    return false;
                } else {
                    clearError(id);
                    return true;
                }
        }
        return true;
    }

    $("#editFullName").on("input", function() {
        validateEditField("editFullName");
    });

    let editEmailChecker = null;

    $("#editEmail").on("input", function() {
        clearTimeout(editEmailChecker);
        let email = $(this).val().trim();

        if (!email.length) {
            clearError("editEmail");
            return;
        }
        if (!isValidEmail(email)) {
            showError("editEmail", "Invalid email format");
            return;
        }
        if (email == originalUserData.email) {
            clearError("editEmail");
            $("#editEmail_error").html("<span class='text-gray-500 text-xs'>No change</span>");
        }

        editEmailChecker = setTimeout(() => {
            ajaxGet("checkUsername", {
                email: email
            }, function(res) {
                if (res.status == "exists") {
                    showError("editEmail", "Email already registered");
                } else if (res.status == "success") {
                    clearError("editEmail");
                    $("#editEmail_error").html("<span class='text-green-600 text-xs'>✓ Valid email</span>");

                } else {
                    showError("editEmail", "Error checking email");
                }
            });
        }, 400);
    });

    $("#editPhone").on("input", function() {
        validateEditField("editPhone");
    });

    $(document).on("click", "#cancelEditModal", function() {
        toggleModal("editUserModal", false);
    });

    $("#editUserForm").submit(function(e) {
        e.preventDefault();

        // Validate all fields
        let isValid = true;
        ["editFullName", "editEmail", "editPhone"].forEach((id) => {
            if (!validateEditField(id)) {
                isValid = false;
            }
        });

        if (!isValid) {
            notyf.error("Please correct highlighted errors");
            return;
        }

        let userId = $("#editUserId").val();
        let fullName = $("#editFullName").val().trim();
        let email = $("#editEmail").val().trim();
        let phone = $("#editPhone").val().trim();
        let expertise = "";

        if ($("#editExpertiseBlock").is(":visible")) {
            let expertiseArr = $("#editExpertise").val();
            expertise = (expertiseArr || []).join(",");
        }

        // Check for changes
        let hasChanges = (
            originalUserData.full_name !== fullName ||
            originalUserData.email !== email ||
            originalUserData.phone_no !== phone ||
            originalUserData.expertise !== expertise
        );

        if (!hasChanges) {
            notyf.error("No changes detected");
            return;
        }

        ajaxPost(
            "updateUser", {
                user_id: userId,
                full_name: fullName,
                email: email,
                phone_no: phone,
                expertise: expertise,
            },
            function(res) {
                if (res.status == "success") {
                    notyf.success(res.message || "User updated successfully");
                    toggleModal("editUserModal", false);
                    loadUsers(role);
                } else {
                    notyf.error(res.message || "Failed to update user");
                }
            }
        );
    });

    // Delete User
    $(document).on("click", ".deleteUser", function() {
        let userId = $(this).data("id");

        if (currentUserInfo.userId === userId) {
            notyf.error("You cannot delete your own account!");
            return;
        }

       showDeleteConfirm("Delete user", function() {
        ajaxPost("deleteUser", { userId }, function(res) {
         if (res.status == "success") {
          notyf.success(res.message);
          loadUsers(role);
        } else {
          notyf.error(res.message);
        }
      });
    });
    });

	$(document).on("click", ".restoreUser", function() {
	    let userId = $(this).data("id");
	    
	    Swal.fire({
	        title: "Restore User?",
	        text: "This will reactivate the user account.",
	        icon: "question",
	        showCancelButton: true,
	        confirmButtonColor: "#16a34a",
	        confirmButtonText: "Yes, restore!"
	    }).then((result) => {
	        if (result.isConfirmed) {
	            ajaxPost("restoreUser", { userId }, function(res) {
	                if (res.status == "success") {
	                    notyf.success(res.message);
	                    loadUsers(role);
	                } else {
	                    notyf.error(res.message);
	                }
	            });
	        }
	    });
	});
	
}
const notyf = new Notyf({
  duration: 2500,
  position: { x: "right", y: "top" },
  types: [
    { type: "success", background: "#16a34a", icon: false },
    { type: "error", background: "#dc2626", icon: false },
    { type: "warning", background: "#f59e0b", icon: false },
    { type: "info", background: "#3b82f6", icon: false } 
  ]
});

// AJAX POST function
function ajaxPost(action, data, successCallback, errorCallback) {
    $.ajax({
        url: "MainServlet",
        method: "POST",
        data: Object.assign({
            action: action
        }, data),
        dataType: "json",
        success: function(response) {
            if (typeof successCallback == 'function') {
                successCallback(response);
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX POST Error:", error);
            console.error("Status:", status);
            console.error("Response:", xhr.responseText);

            if (typeof errorCallback == 'function') {
                errorCallback(xhr, status, error);
            } else {
                notyf.error("Server Error. Please try again.");
            }
        }
    });
}

// AJAX GET function
function ajaxGet(action, data, successCallback, errorCallback) {
    $.ajax({
        url: "MainServlet",
        method: "GET",
        data: Object.assign({
            action: action
        }, data),
        dataType: "json",
        success: function(response) {
            if (typeof successCallback == 'function') {
                successCallback(response);
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX GET Error:", error);
            console.error("Status:", status);
            console.error("Response:", xhr.responseText);

            if (typeof errorCallback == 'function') {
                errorCallback(xhr, status, error);
            } else {
                notyf.error("Server Error. Please try again.");
            }
        }
    });
}

function getUserDetails() {
    ajaxGet("getUserDetails", {},
        function(res) {
            if (res.status == "success") {
				currentUserInfo.userId = String(res.user_id);
				            currentUserInfo.role = res.role;
							currentUserInfo.userId = String(res.userId);
							
				            console.log("Current User ID:", currentUserInfo.userId);
				            console.log("Current User Role:", currentUserInfo.role);
                $("#userFullName").text(`Hi, ${res.fullName} (${res.role})`);
                //console.log(res.fullName)
            } else {
                Swal.fire({
                    title: "Session expired",
                    text: "Please Log in again",
                    icon: "warning",
                    confirmButtonColor: "#2563eb",
                }).then(() =>
                    (window.location.href = "index.html"));
            }
        });
}

function openProfilePanel() {
  ajaxGet("getUserDetails", {}, function(res) {
    if (res.status == "success") {
      $("#profileUsername").val(res.username);
      $("#profileEmail").val(res.email);
      $("#profileFullName").val(res.fullName);
      $("#profilePhone").val(res.phoneNo || "");
      
      if (res.role == "PANEL") {
        $("#profileExpertiseBlock").show();
        $("#profileExpertise").val(res.expertise || "");
      }
      
      $("#profilePanel").removeClass("hidden");
      setTimeout(() => $("#profileSlide").removeClass("translate-x-full"), 10);
    }
  });
}

function closeProfilePanel() {
  $("#profileSlide").addClass("translate-x-full");
  setTimeout(() => $("#profilePanel").addClass("hidden"), 300);
}


// Toggle modal visibility
function toggleModal(modalId, show) {
    if (show) {
        $("#" + modalId).removeClass("hidden");
    } else {
        $("#" + modalId).addClass("hidden");
    }
}

// Format date
function formatDate(dateString) {
    if (!dateString) return "-";
    let date = new Date(dateString);
    return date.toLocaleDateString() + " " + date.toLocaleTimeString();
}

// Validate email
function isValidEmail(email) {
    return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email);
}

// Validate phone number (10 digits)
function isValidPhone(phone) {
    return /^[0-9]{10}$/.test(phone);
}

// Show error message on input field
function showError(inputId, message) {
    $("#" + inputId).addClass("border-red-500");
    $("#" + inputId + "_error").text(message);
}

// Clear error message from input field
function clearError(inputId) {
    $("#" + inputId).removeClass("border-red-500");
    $("#" + inputId + "_error").text("");
}


// Confirm dialog with SweetAlert
function showConfirmDialog(title, message, onConfirm) {
    Swal.fire({
        title: title,
        text: message,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, proceed!'
    }).then((result) => {
        if (result.isConfirmed && typeof onConfirm == 'function') {
            onConfirm();
        }
    });
}

//Delete Confirm
function showDeleteConfirm(title,callback) {
    Swal.fire({
    title: title,
    text: "This action cannot be undone.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#dc2626",
    confirmButtonText: "Yes, delete"
  }).then((result) => {
    if (result.isConfirmed) callback();
  });
}


//Utility for destroying table
function initDataTable(tableId, options) {
  if ($.fn.DataTable.isDataTable(tableId)) {
    $(tableId).DataTable().destroy();
  }
  return $(tableId).DataTable(options);
}

// Assessment Utilities
let AssessmentUtils = {
    showTable: function(assessments) {
        let html = "<div class='flex justify-between mb-4'>";
        html += "<h2 class='text-2xl font-bold'>My Assessments</h2>";
        html += "<button id='btnAddAssessment' class='bg-blue-600 text-white px-4 py-2 rounded'>+ Add Assessment</button>";
        html += "</div>";
        html += "<table id='assessmentTable' class='display nowrap min-w-full bg-white rounded shadow'>";
        html += "<thead class='bg-gray-100'><tr>";
        html += "<th>Name</th><th>Subject</th><th>Duration</th><th>Total Marks</th><th>Passing</th><th>Actions</th>";
        html += "</tr></thead><tbody>";

        if (assessments && assessments.length > 0) {
            for (let i = 0; i < assessments.length; i++) {
                let a = assessments[i];
                html += "<tr>";
                html += "<td>" + (a.assessment_name) + "</td>";
                html += "<td>" + (a.subject) + "</td>";
                html += "<td>" + (a.duration_minutes) + " mins</td>";
                html += "<td>" + (a.total_marks) + "</td>";
                html += "<td>" + (a.passing_marks) + "</td>";
                html += "<td class='space-x-1'>";
                html += "<button class='editAssessment bg-yellow-500 text-white px-2 py-1 rounded' data-id='" + a.assessment_id + "'>Edit</button>";
                html += "<button class='deleteAssessment bg-red-600 text-white px-2 py-1 rounded' data-id='" + a.assessment_id + "'>Delete</button>";
                html += "<button class='manageQuestions bg-green-600 text-white px-2 py-1 rounded' data-id='" + a.assessment_id + "'>+ Question</button>";
                html += "</td></tr>";
            }
        }

        html += "</tbody></table>";
        $("#assessmentSection").html(html);

        if ($.fn.DataTable.isDataTable("#assessmentTable")) {
            $("#assessmentTable").DataTable().destroy();
        }

        $("#assessmentTable").DataTable({
            pageLength: 5,
            responsive: true,
            destroy: true
        });
    },

    renderQuestions: function(questions, assessmentId) {
        let rows = "";
        if (questions && questions.length > 0) {
            for (let i = 0; i < questions.length; i++) {
                let q = questions[i];
                rows += "<tr class='border-b'>";
                rows += "<td class='px-2 py-1'>" + (i + 1) + "</td>";
                rows += "<td class='px-2 py-1'>" + (q.question_text) + "</td>";
                rows += "<td class='px-2 py-1 text-sm'>";
                rows += "A) " + (q.option_a) + "<br>B) " + (q.option_b) + "<br>";
                rows += "C) " + (q.option_c) + "<br>D) " + (q.option_d);
                rows += "</td>";
                rows += "<td class='px-2 py-1 text-blue-600 font-semibold'>" + (q.correct_answer) + "</td>";
                rows += "<td class='px-2 py-1'>" + (q.marks) + "</td>";
                rows += "<td class='px-2 py-1'>";
                rows += "<button class='editQuestion bg-yellow-500 text-white px-2 py-1 rounded'";
                rows += " data-assessment='" + assessmentId + "'";
                rows += " data-qid='" + q.question_id + "'";
                rows += " data-qtext='" + (q.question_text) + "'";
                rows += " data-oa='" + (q.option_a) + "'";
                rows += " data-ob='" + (q.option_b) + "'";
                rows += " data-oc='" + (q.option_c) + "'";
                rows += " data-od='" + (q.option_d) + "'";
                rows += " data-correct='" + (q.correct_answer) + "'";
                rows += " data-marks='" + q.marks + "'>Edit</button>";
                rows += "<button class='deleteQuestion bg-red-600 text-white px-2 py-1 rounded ml-1'";
                rows += " data-assessment='" + assessmentId + "' data-id='" + q.question_id + "'>Delete</button>";
                rows += "</td></tr>";
            }
        } else {
            rows = "<tr><td colspan='6' class='text-center text-gray-500 py-4'>No questions yet</td></tr>";
        }
        $("#questionTableBody").html(rows);
    }
};

// Dashboard Utilities
let DashboardUtils = {
    renderCard: function(title, value) {
        let html = "<div class='bg-white p-4 rounded shadow text-center hover:shadow-md transition'>";
        html += "<p class='text-gray-600'>" + (title) + "</p>";
        html += "<h3 class='text-3xl text-blue-600 font-bold'>" +(value) + "</h3>";
        html += "</div>";
        return html;
    }
};

// Logout user
function logoutUser() {
	Swal.fire({
	  title: "Logout",
	  text: "Are you sure?",
	  icon: "question",
	  showCancelButton: true,
	  confirmButtonColor: "#2563eb",
	  confirmButtonText: "Logout",
	}).then((result) => {
	  if (result.isConfirmed) {
	    setTimeout(() => {
	      notyf.open({ type: "info", message: "Logging out..." });
	    }, 300);
	    ajaxPost("logout", {}, function(res) {
	      setTimeout(() => {
	        window.location.href = "index.html";
	      }, 800);
	    });
	  }
	});

}
